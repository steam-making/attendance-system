{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
    <div class="bg-white shadow-sm ring-1 ring-slate-900/5 sm:rounded-xl md:col-span-2">
        <div class="px-4 py-6 sm:p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold leading-7 text-slate-900 sm:truncate sm:text-3xl sm:tracking-tight">학교 등록</h1>
                <p class="mt-2 text-sm text-slate-500">새로운 학교 정보를 입력해주세요.</p>
            </div>

            <form method="post" novalidate class="space-y-8">
                {% csrf_token %}

                <!-- 기본 정보 -->
                <div>
                    <h2 class="text-base font-semibold leading-7 text-slate-900">기본 정보</h2>
                    <p class="mt-1 text-sm leading-6 text-slate-500">학교의 기본 정보를 입력하세요.</p>

                    <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">
                        <div class="sm:col-span-3">
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium leading-6 text-slate-900">{{ form.name.label }}</label>
                            <div class="mt-2">
                                {{ form.name|add_class:"block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6 px-3" }}
                            </div>
                            {% if form.name.errors %}
                                <p class="mt-2 text-sm text-red-600">{% for error in form.name.errors %}{{ error }}{% endfor %}</p>
                            {% endif %}
                        </div>

                        <div class="sm:col-span-3">
                            <label for="{{ form.program_name.id_for_label }}" class="block text-sm font-medium leading-6 text-slate-900">{{ form.program_name.label }}</label>
                            <div class="mt-2">
                                {{ form.program_name|add_class:"block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6 px-3" }}
                            </div>
                            {% if form.program_name.errors %}
                                <p class="mt-2 text-sm text-red-600">{% for error in form.program_name.errors %}{{ error }}{% endfor %}</p>
                            {% endif %}
                            <p class="mt-2 text-sm text-slate-500">{{ form.program_name.help_text }}</p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-900/10 pt-8">
                    <h2 class="text-base font-semibold leading-7 text-slate-900">수업 요일</h2>
                    <p class="mt-1 text-sm leading-6 text-slate-500">수업이 진행되는 요일을 선택하세요.</p>
                    
                    <div class="mt-6 space-y-6">
                        <div class="relative flex gap-x-3">
                            <div class="flex h-6 items-center">
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full">
                                    {% for choice in form.class_days %}
                                        <div class="relative flex items-start">
                                            <div class="flex h-6 items-center">
                                                {{ choice.tag }}
                                            </div>
                                            <div class="ml-3 text-sm leading-6">
                                                <label for="{{ choice.id_for_label }}" class="font-medium text-slate-900">{{ choice.choice_label }}</label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% if form.class_days.errors %}
                            <p class="mt-2 text-sm text-red-600">{% for error in form.class_days.errors %}{{ error }}{% endfor %}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="border-t border-slate-900/10 pt-8">
                    <h2 class="text-base font-semibold leading-7 text-slate-900">운영 부서</h2>
                    <p class="mt-1 text-sm leading-6 text-slate-500">운영하는 부서를 선택하세요.</p>
                    
                    <div class="mt-6">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            {% for choice in form.departments %}
                                <div class="relative flex items-start">
                                    <div class="flex h-6 items-center">
                                        {{ choice.tag }}
                                    </div>
                                    <div class="ml-3 text-sm leading-6">
                                        <label for="{{ choice.id_for_label }}" class="font-medium text-slate-900">{{ choice.choice_label }}</label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% if form.departments.errors %}
                            <p class="mt-2 text-sm text-red-600">{% for error in form.departments.errors %}{{ error }}{% endfor %}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="border-t border-slate-900/10 pt-8">
                    <h2 class="text-base font-semibold leading-7 text-slate-900">부서별 수업 시간 설정</h2>
                    <p class="mt-1 text-sm leading-6 text-slate-500">각 부서의 수업 시간을 설정하세요.</p>

                    <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-3">
                        <div>
                            <label for="{{ form.first_class_start.id_for_label }}" class="block text-sm font-medium leading-6 text-slate-900">{{ form.first_class_start.label }}</label>
                            <div class="mt-2">
                                {{ form.first_class_start|add_class:"block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6 px-3" }}
                            </div>
                        </div>
                        <div>
                            <label for="{{ form.class_duration.id_for_label }}" class="block text-sm font-medium leading-6 text-slate-900">{{ form.class_duration.label }}</label>
                            <div class="mt-2">
                                {{ form.class_duration|add_class:"block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6 px-3" }}
                            </div>
                        </div>
                        <div>
                            <label for="{{ form.break_time.id_for_label }}" class="block text-sm font-medium leading-6 text-slate-900">{{ form.break_time.label }}</label>
                            <div class="mt-2">
                                {{ form.break_time|add_class:"block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6 px-3" }}
                            </div>
                        </div>
                    </div>

                    <!-- Calculated Times -->
                    <div class="mt-6 bg-slate-50 rounded-lg p-4 border border-slate-200">
                        <h3 class="text-sm font-medium text-slate-900 mb-3">계산된 부서별 시간</h3>
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 uppercase">1부 시간</label>
                                <input type="text" id="dept1_time" readonly class="mt-1 block w-full rounded-md border-0 py-1.5 bg-white text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 sm:text-sm sm:leading-6 px-3">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 uppercase">2부 시간</label>
                                <input type="text" id="dept2_time" readonly class="mt-1 block w-full rounded-md border-0 py-1.5 bg-white text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 sm:text-sm sm:leading-6 px-3">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 uppercase">3부 시간</label>
                                <input type="text" id="dept3_time" readonly class="mt-1 block w-full rounded-md border-0 py-1.5 bg-white text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 sm:text-sm sm:leading-6 px-3">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-x-6 border-t border-slate-900/10 pt-8">
                    <a href="{% url 'select_school' %}" class="text-sm font-semibold leading-6 text-slate-900 hover:text-slate-700">취소</a>
                    <button type="submit" class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">등록하기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function calculateAllTimes() {
        const firstClassStart = document.querySelector('[name="first_class_start"]')?.value;
        const classDuration = parseInt(document.querySelector('[name="class_duration"]')?.value);
        const breakTime = parseInt(document.querySelector('[name="break_time"]')?.value);

        const dept1Input = document.getElementById('dept1_time');
        const dept2Input = document.getElementById('dept2_time');
        const dept3Input = document.getElementById('dept3_time');

        if (firstClassStart && classDuration && breakTime) {
            const [hours, minutes] = firstClassStart.split(':').map(Number);
            const startMinutes = hours * 60 + minutes;

            const dept1Start = startMinutes;
            const dept1End = startMinutes + classDuration;

            const dept2Start = dept1End + breakTime;
            const dept2End = dept2Start + classDuration;

            const dept3Start = dept2End + breakTime;
            const dept3End = dept3Start + classDuration;

            const formatTime = (totalMinutes) => {
                const h = Math.floor(totalMinutes / 60) % 24;
                const m = totalMinutes % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            dept1Input.value = `${formatTime(dept1Start)} ~ ${formatTime(dept1End)}`;
            dept2Input.value = `${formatTime(dept2Start)} ~ ${formatTime(dept2End)}`;
            dept3Input.value = `${formatTime(dept3Start)} ~ ${formatTime(dept3End)}`;
        } else {
            dept1Input.value = '';
            dept2Input.value = '';
            dept3Input.value = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('[name="first_class_start"], [name="class_duration"], [name="break_time"]');
        inputs.forEach(input => {
            input.addEventListener('input', calculateAllTimes);
        });
        calculateAllTimes();
    });
</script>
{% endblock %}
