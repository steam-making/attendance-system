{% extends 'base.html' %}
{% block extra_head %}
<style>
    tr.selected-row > td {
        background-color:#f8f8f8 !important;
    }

    /* í…Œì´ë¸” ì•ˆì˜ ì…€ í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ */
    table td, table th {
    white-space: nowrap;
    }
</style>

</style>
{% endblock %}
{% block content %}
{% load static %}
{% load extra_filters %}
<div class="container-fluid p-0 m-0">

    <div class="d-flex justify-content-between align-items-center flex-wrap">
        
        <!-- âœ… í•™êµ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <form method="get" class="d-flex align-items-center">
            <select name="school" onchange="this.form.submit()" class="form-select me-2">
                {% for school in schools %}
                    <option value="{{ school.id }}" {% if selected_school.id == school.id %}selected{% endif %}>
                        {{ school.name }} {{school.program_name}}
                    </option>
                {% endfor %}
            </select>
        </form>

        <!-- âœ… ì˜¤ë¥¸ìª½ ë²„íŠ¼ ê·¸ë£¹ -->
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <!-- âœ… í˜„ì¬ ì¶œì„ í•™ìƒ ì „ì²´ ì„ íƒ ë²„íŠ¼ -->
            <button type="button" class="btn btn-outline-primary" onclick="selectPresentStudents()">ì¶œì„ëª¨ë‘ì„ íƒ</button>
            <a href="{% url 'student_create' %}?school={{ selected_school.id }}" class="btn btn-success">í•™ìƒ ë“±ë¡</a>
            <a href="{% url 'upload_students_excel' %}?school={{ selected_school.id }}" class="btn btn-warning">ì—‘ì…€ ì—…ë¡œë“œ</a>
            <button type="button" class="btn btn-danger" onclick="deleteSelectedStudents()">ì„ íƒ ì‚­ì œ</button>
        </div>

    </div>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div style="flex: 0 0 auto;">
        
        {% for department, students in departments.items %}
        <h4 class="mt-2">{{ department }} ({{ students|length }}ëª…)</h4>
            <!-- âœ… ì™¼ìª½ ê³ ì • ì—´ -->
            <div style="flex: 0 0 auto;">
            <table class="table text-center m-0" style="min-width: 300px;">
                
                <thead class="{{ color_map_header|dict_get:department }}">
                <tr>
                    <th><input type="checkbox" id="select-all-{{ department }}" onclick="toggleDepartment('{{ department }}', this)"></th>
                    <th>í•™ë…„/ë°˜/ë²ˆí˜¸</th>
                    <th>ì´ë¦„</th>
                    <th>ì²´í¬</th>
                </tr>
                </thead>
                <tbody>
                {% for student in students %}
                <tr onclick="toggleRowSelection(this)">
                    <td><input type="checkbox" class="student-checkbox checkbox-{{ department }}" value="{{ student.id }}"></td>
                    <td>{{ student.grade }}{{ student.classroom }}{{ student.number|stringformat:"02d" }}</td>
                    <td>{{ student.name }}</td>
                    <td id="attendance-cell-{{ student.id }}">
                        {% with attendances|dict_get:student.id as attendance %}
                        {% if attendance %}
                            {% if attendance.status == 'ì¢…ë£Œì²˜ë¦¬' %}
                                <span class="text-secondary fw-bold">âœ” ìˆ˜ì—… ì¢…ë£Œ</span>
                            {% elif student.id in attendances %}
                                <button onclick="cancelAttendance({{ student.id }}, 'attendance-cell-{{ student.id }}')" class="btn btn-outline-danger btn-sm ms-2">ì·¨ì†Œ</button>
                                <!-- ì¢…ë£Œ ë²„íŠ¼ -->
                                <button onclick="endAttendance({{ student.id }}, 'attendance-cell-{{ student.id }}', '{{ student.name }}', '{{ student.phone }}')" class="btn btn-outline-secondary btn-sm ms-2">ì¢…ë£Œ</button>
                                <a href="sms:{{ student.phone }}?body={{ student.name }}ë‹˜ ì˜¤ëŠ˜ ì¶œì„ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤." class="btn btn-sm btn-outline-primary ms-2">ë¬¸ì ë³´ë‚´ê¸°</a>
                            {% endif %}
                        {% else %}
                            <button onclick="checkAttendance({{ student.id }}, 'ì¶œì„', 'attendance-cell-{{ student.id }}')" class="btn btn-success btn-sm">ì¶œì„</button>
                            <button onclick="checkAttendance({{ student.id }}, 'ì§€ê°', 'attendance-cell-{{ student.id }}')" class="btn btn-warning btn-sm">ì§€ê°</button>
                            <button onclick="checkAttendance({{ student.id }}, 'ê²°ì„', 'attendance-cell-{{ student.id }}')" class="btn btn-danger btn-sm">ê²°ì„</button>
                            <a href="{% url 'student_update' student.id %}" class="btn btn-sm btn-outline-warning ms-1">ìˆ˜ì •</a>
                        {% endif %}
                        {% endwith %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
    </div>
        {% endfor %}
    

    

</div>
<script>
   

    function endAttendance(studentId, rowId, name, phone) {
        fetch(`/attendance/ajax/end/${studentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ended') {
                
                // âœ… "ìˆ˜ì—… ì¢…ë£Œ" ë©”ì‹œì§€ë¡œ ë²„íŠ¼ ì˜ì—­ êµì²´
                document.getElementById(rowId).innerHTML = `
                    <span class="text-secondary fw-bold">âœ” ìˆ˜ì—… ì¢…ë£Œ</span>
                `;
            } else {
                alert('ì¶œì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
    }

    function selectPresentStudents() {
        // ì¶œì„í•œ í•™ìƒë“¤ì˜ checkboxë¥¼ ëª¨ë‘ ì„ íƒ
        document.querySelectorAll('.student-checkbox').forEach(cb => {
            const row = cb.closest('tr');
            if (row && row.querySelector('.btn-outline-danger')) {
                cb.checked = true;
                row.classList.add('selected-row');
            } else {
                cb.checked = false;
                row.classList.remove('selected-row');
            }
        });
    }


    function toggleDepartment(dept, source) {
        document.querySelectorAll(`.checkbox-${dept}`).forEach(cb => cb.checked = source.checked);
    }

    function checkAttendance(studentId, status, rowId) {
        fetch(`/attendance/ajax/check/${studentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                status: status,
                program_name: '{{ selected_school.program_name }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("checkAttendance ì‘ë‹µ:", data);

            if (data.status === 'success') {

                // âœ… ì•±(WebView)ì—ì„œë§Œ ìë™ë¬¸ì ì‹¤í–‰
                if (window.Android && typeof window.Android.sendSms === "function") {
                    const phone = data.phone;
                    const name = data.student;
                    const createdAt = data.created_at;
                    const msg = `${name}ë‹˜ ì˜¤ëŠ˜ ${status} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (${createdAt})`;

                    console.log("ğŸ“© Android.sendSms í˜¸ì¶œ:", phone, msg);
                    window.Android.sendSms(phone, msg);
                } else {
                    console.log("âš ï¸ Android ë¸Œë¦¿ì§€ ì—†ìŒ(ë¸Œë¼ìš°ì € ì ‘ì†ì´ê±°ë‚˜ ë¸Œë¦¿ì§€ ë¯¸ì—°ê²°)");
                }


                const program = data.program_name;
                const phone = data.phone;
                const name = data.student;
                const createdAt = data.created_at;
                const message = `${name}ë‹˜ ì˜¤ëŠ˜ ${status} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                const smsUrl = `sms:${phone}?body=${encodeURIComponent(message)}`;

                const timeCell = document.getElementById(`time-cell-${studentId}`);
                if (timeCell) {
                    timeCell.innerText = createdAt;
                }

                // âœ… ë²„íŠ¼ ì˜ì—­ ì¡°ê±´ë³„ë¡œ ë‚˜ëˆ”
                if (status === 'ì§€ê°') {
                    document.getElementById(rowId).innerHTML = `
                        <button onclick="checkAttendance(${studentId}, 'ì¶œì„', '${rowId}')" class="btn btn-success btn-sm">ì¶œì„</button>
                        <button onclick="checkAttendance(${studentId}, 'ê²°ì„', '${rowId}')" class="btn btn-danger btn-sm">ê²°ì„</button>
                        <a href="/attendance/student/update/${studentId}/" class="btn btn-sm btn-outline-warning ms-1">ìˆ˜ì •</a>
                    `;
                } else {
                    document.getElementById(rowId).innerHTML = `
                        <button onclick="cancelAttendance(${studentId}, '${rowId}')" class="btn btn-outline-danger btn-sm ms-2">ì·¨ì†Œ</button>
                        <button onclick="endAttendance(${studentId}, '${rowId}', '${name}', '${phone}')" class="btn btn-outline-secondary btn-sm ms-2">ì¢…ë£Œ</button>
                        <a href="${smsUrl}" class="btn btn-sm btn-outline-primary ms-2">ë¬¸ì ë³´ë‚´ê¸°</a>
                    `;
                }
            } else if (data.status === 'already_checked') {
                alert("ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(error => {
            console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
        });
    }


    function cancelAttendance(studentId, rowId) {
        fetch(`/attendance/ajax/cancel/${studentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'canceled') {
                document.getElementById(rowId).innerHTML = `
                <button onclick="checkAttendance(${studentId}, 'ì¶œì„', '${rowId}')" class="btn btn-success btn-sm">ì¶œì„</button>
                <button onclick="checkAttendance(${studentId}, 'ì§€ê°', '${rowId}')" class="btn btn-warning btn-sm">ì§€ê°</button>
                <button onclick="checkAttendance(${studentId}, 'ê²°ì„', '${rowId}')" class="btn btn-danger btn-sm">ê²°ì„</button>
                <a href="/attendance/student/update/${studentId}/" class="btn btn-sm btn-outline-warning ms-1">ìˆ˜ì •</a>
                `;

                // âœ… ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ í™”ë©´ ì¦‰ì‹œ ë°˜ì˜
                //window.location.reload();
            }
        });
    }

    // CSRF í† í°ì„ fetch ìš”ì²­ì— ë„£ê¸° ìœ„í•¨
    const csrfToken = '{{ csrf_token }}';

    function toggleAll(source) {
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = source.checked);
    }

    function deleteSelectedStudents() {
        const selected = Array.from(document.querySelectorAll('.student-checkbox:checked'))
            .map(cb => parseInt(cb.value));

        if (selected.length === 0) {
            alert("ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        if (!confirm("ì •ë§ ì„ íƒí•œ í•™ìƒë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("{% url 'delete_selected_students' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ student_ids: selected })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`${data.deleted_count}ëª…ì˜ í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                window.location.reload();
            } else {
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
    
    function toggleRowSelection(row) {
        const checkbox = row.querySelector('.student-checkbox');
        if (!checkbox) return;

        checkbox.checked = !checkbox.checked;
        row.classList.toggle('selected-row', checkbox.checked);
    }

    // âœ… ì²´í¬ë°•ìŠ¤ ì§ì ‘ í´ë¦­ ì‹œì—ë„ ìŠ¤íƒ€ì¼ ìœ ì§€ë˜ê²Œ ì—°ê²°
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.student-checkbox').forEach(cb => {
            cb.addEventListener('change', function () {
                const row = this.closest('tr');
                if (row) {
                    row.classList.toggle('selected-row', this.checked);
                }
            });
        });
    });
</script>
{% endblock %}