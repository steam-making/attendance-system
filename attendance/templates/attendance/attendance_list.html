{% extends 'base.html' %}
{% block extra_head %}
<style>
  tr.selected-row > td { background-color:#f8f8f8 !important; }

  /* âœ… í…Œì´ë¸” */
  .student-table{
    width:100%;
    table-layout: fixed; /* ê³ ì • ë ˆì´ì•„ì›ƒ */
    border-collapse: collapse;
  }

  /* âœ… í‘œ ì•ˆ ë‚´ìš©: ëª¨ë‘ ê°€ìš´ë°(ê°€ë¡œ/ì„¸ë¡œ) */
  .student-table th,
  .student-table td{
    text-align:center;
    vertical-align:middle;
    white-space:nowrap;          /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
    padding: .5rem .5rem;        /* ê¸°ë³¸ ê°„ê²© í†µì¼ */
  }

  /* âœ… í—¤ë” ê¸€ìëŠ” ì˜ë¦¬ì§€ ì•Šê²Œ */
  .student-table th{
    overflow: visible;
    text-overflow: clip;
    font-weight: 700;
  }

  /* âœ… ë³¸ë¬¸ì€ ë„˜ì¹˜ë©´ ... */
  .student-table td{
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* âœ… ì²´í¬ì¹¸(ì²« ì—´): table-cell ìœ ì§€ + ì²´í¬ë°•ìŠ¤ë§Œ ê°€ìš´ë° ì •ë ¬ */
  th.col-check,
  td.col-check{
    padding: 0 !important;       /* ì²´í¬ì¹¸ì€ íŒ¨ë”© ì œê±° */
  }
  th.col-check input,
  td.col-check input{
    display:block;               /* ê°€ìš´ë° ì •ë ¬ í™•ì‹¤ */
    margin: 0 auto;              /* ê°€ë¡œ ì¤‘ì•™ */
  }

  /* âœ… ë²„íŠ¼ ì˜ì—­: ê°€ìš´ë° ì •ë ¬ + í•œ ì¤„ ìœ ì§€ */
  .cell-actions{
    display:flex;
    justify-content:center;      /* âœ… ê°€ìš´ë° ì •ë ¬ë¡œ ë³€ê²½ */
    align-items:center;          /* âœ… ì„¸ë¡œ ì¤‘ì•™ */
    gap:.25rem;
    flex-wrap:nowrap;
    min-width:0;
  }

  /* âœ… ë²„íŠ¼ XS */
  .btn-xs{
    padding: .18rem .38rem;
    font-size: .75rem;
    line-height: 1.15;
    border-radius: .45rem;
  }

  /* âœ… ëª¨ë°”ì¼: í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  ì•„ì´ì½˜ë§Œ */
  @media (max-width: 768px){
    .btn-text { display:none !important; }
  }

  /* âœ… colgroup í­: í‰ì†Œì—” ê· ë“±(3ì¹¸), ì¢ì•„ì§€ë©´ ì²´í¬ì¹¸ë§Œ ì¤„ì–´ë“¦ */
  /* ê¸°ë³¸ ì²´í¬ì¹¸ í­ */
  col.col-check { width: 40px; }

  /* ë‚˜ë¨¸ì§€ 3ì¹¸ì€ ê· ë“± ë¶„ë°° */
  col.col-gbn,
  col.col-name,
  col.col-action { width: calc((100% - 40px)/3); }

  /* í™”ë©´ì´ ë” ì¢ì•„ì§€ë©´ ì²´í¬ì¹¸ë§Œ ë” ì¤„ì´ê¸° */
  @media (max-width: 480px){
    col.col-check { width: 28px; }
    col.col-gbn,
    col.col-name,
    col.col-action { width: calc((100% - 28px)/3); }
    .student-table th,
    .student-table td{ padding: .45rem .35rem; }
  }
</style>

{% endblock %}

{% block content %}
{% load static %}
{% load extra_filters %}
<div class="container-fluid p-0 m-0">

    <div class="d-flex justify-content-between align-items-center flex-wrap">

        <!-- âœ… í•™êµ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <form method="get" class="d-flex align-items-center">
            <select name="school" onchange="this.form.submit()" class="form-select me-2">
                {% for school in schools %}
                    <option value="{{ school.id }}" {% if selected_school.id == school.id %}selected{% endif %}>
                        {{ school.name }} {{school.program_name}}
                    </option>
                {% endfor %}
            </select>
        </form>

        <!-- âœ… ì˜¤ë¥¸ìª½ ë²„íŠ¼ ê·¸ë£¹ (ëª¨ë°”ì¼ ë°˜ì‘í˜• ê°œì„ ) -->
        <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPresentStudents()">
                ì¶œì„ëª¨ë‘ì„ íƒ
            </button>

            <a href="{% url 'student_create' %}?school={{ selected_school.id }}" class="btn btn-success btn-sm">
                í•™ìƒ ë“±ë¡
            </a>

            <a href="{% url 'upload_students_excel' %}?school={{ selected_school.id }}" class="btn btn-warning btn-sm">
                ì—‘ì…€ ì—…ë¡œë“œ
            </a>

            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedStudents()">
                ì„ íƒ ì‚­ì œ
            </button>
        </div>

    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div style="flex: 0 0 auto;">

        {% for department, students in departments.items %}
        <h4 class="mt-2">{{ department }} ({{ students|length }}ëª…)</h4>

        <div style="flex: 0 0 auto;">
            <table class="table text-center m-0 student-table" style="min-width:0;">
              <colgroup>
                <col class="col-check">
                <col class="col-gbn">
                <col class="col-name">
                <col class="col-action">
              </colgroup>

              <thead class="{{ color_map_header|dict_get:department }}">
                <tr>
                  <th class="col-check">
                    <input type="checkbox" id="select-all-{{ department }}" onclick="toggleDepartment('{{ department }}', this)">
                  </th>
                  <th class="col-gbn">í•™ë…„/ë°˜/ë²ˆí˜¸</th>
                  <th class="col-name">ì´ë¦„</th>
                  <th>ì²´í¬</th>
                </tr>
              </thead>

              <tbody>
              {% for student in students %}
                <tr onclick="toggleRowSelection(this)">
                  <td class="col-check">
                    <input type="checkbox" class="student-checkbox checkbox-{{ department }}" value="{{ student.id }}">
                  </td>

                  <td class="col-gbn">
                    {{ student.grade }}{{ student.classroom }}{{ student.number|stringformat:"02d" }}
                  </td>

                  <td class="col-name">
                    {{ student.name }}
                  </td>

                  <td id="attendance-cell-{{ student.id }}">
                    <div class="cell-actions">
                      {% with attendances|dict_get:student.id as attendance %}
                      {% if attendance %}
                          {% if attendance.status == 'ì¢…ë£Œì²˜ë¦¬' %}
                              <span class="text-secondary fw-bold">âœ” ìˆ˜ì—… ì¢…ë£Œ</span>
                          {% elif student.id in attendances %}
                              <button onclick="cancelAttendance({{ student.id }}, 'attendance-cell-{{ student.id }}')"
                                      class="btn btn-outline-danger btn-xs"
                                      title="ì·¨ì†Œ">âœ– <span class="btn-text">ì·¨ì†Œ</span></button>

                              <button onclick="endAttendance({{ student.id }}, 'attendance-cell-{{ student.id }}', '{{ student.name }}', '{{ student.phone }}')"
                                      class="btn btn-outline-secondary btn-xs"
                                      title="ì¢…ë£Œ">â¹ <span class="btn-text">ì¢…ë£Œ</span></button>

                              <a href="sms:{{ student.phone }}?body={{ student.name }}ë‹˜ ì˜¤ëŠ˜ ì¶œì„ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."
                                 class="btn btn-outline-primary btn-xs"
                                 title="ë¬¸ì">âœ‰ <span class="btn-text">ë¬¸ì</span></a>
                          {% endif %}
                      {% else %}
                          <button onclick="checkAttendance({{ student.id }}, 'ì¶œì„', 'attendance-cell-{{ student.id }}')"
                                  class="btn btn-success btn-xs"
                                  title="ì¶œì„">âœ… <span class="btn-text">ì¶œì„</span></button>

                          <button onclick="checkAttendance({{ student.id }}, 'ì§€ê°', 'attendance-cell-{{ student.id }}')"
                                  class="btn btn-warning btn-xs"
                                  title="ì§€ê°">â° <span class="btn-text">ì§€ê°</span></button>

                          <button onclick="checkAttendance({{ student.id }}, 'ê²°ì„', 'attendance-cell-{{ student.id }}')"
                                  class="btn btn-danger btn-xs"
                                  title="ê²°ì„">âŒ <span class="btn-text">ê²°ì„</span></button>

                          <a href="{% url 'student_update' student.id %}"
                             class="btn btn-outline-warning btn-xs"
                             title="ìˆ˜ì •">âœï¸ <span class="btn-text">ìˆ˜ì •</span></a>
                      {% endif %}
                      {% endwith %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
        </div>
        {% endfor %}

    </div>
</div>

<script>
    alert("APP_JS_VERSION = 20260130_1827");
    console.log("âœ… APP_JS_VERSION = 20260130_1827");

    function endAttendance(studentId, rowId, name, phone) {
        fetch(`/attendance/ajax/end/${studentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ended') {
                document.getElementById(rowId).innerHTML = `
                    <span class="text-secondary fw-bold">âœ” ìˆ˜ì—… ì¢…ë£Œ</span>
                `;
            } else {
                alert('ì¶œì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
    }

    function selectPresentStudents() {
        document.querySelectorAll('.student-checkbox').forEach(cb => {
            const row = cb.closest('tr');
            if (row && row.querySelector('.btn-outline-danger')) {
                cb.checked = true;
                row.classList.add('selected-row');
            } else {
                cb.checked = false;
                row.classList.remove('selected-row');
            }
        });
    }

    function toggleDepartment(dept, source) {
        document.querySelectorAll(`.checkbox-${dept}`).forEach(cb => cb.checked = source.checked);
    }

    function checkAttendance(studentId, status, rowId) {
        fetch(`/attendance/ajax/check/${studentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: status,
                program_name: '{{ selected_school.program_name }}'
            })
        })
        .then(response => response.json())
        .then(data => {

            console.log("bridge check:", !!window.Android, window.Android);
            console.log("checkAttendance raw:", JSON.stringify(data));
            console.log("checkAttendance status:", data && data.status);

            if (!data || !data.status) {
              console.log("âŒ data/status ì—†ìŒ", data);
            }

            if (data.status === 'success') {

                if (window.Android && typeof window.Android.sendSms === "function") {
                    const phone = data.phone;
                    const name = data.student;
                    const createdAt = data.created_at;
                    const msg = `${name}ë‹˜ ì˜¤ëŠ˜ ${status} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (${createdAt})`;
                    console.log("ğŸ“© Android.sendSms í˜¸ì¶œ:", phone, msg);
                    window.Android.sendSms(phone, msg);
                } else {
                    console.log("âš ï¸ Android ë¸Œë¦¿ì§€ ì—†ìŒ(ë¸Œë¼ìš°ì € ì ‘ì†ì´ê±°ë‚˜ ë¸Œë¦¿ì§€ ë¯¸ì—°ê²°)");
                }

                const phone = data.phone;
                const name = data.student;
                const message = `${name}ë‹˜ ì˜¤ëŠ˜ ${status} ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                const smsUrl = `sms:${phone}?body=${encodeURIComponent(message)}`;

                if (status === 'ì§€ê°') {
                    document.getElementById(rowId).innerHTML = `
                        <div class="cell-actions">
                          <button onclick="checkAttendance(${studentId}, 'ì¶œì„', '${rowId}')" class="btn btn-success btn-xs">âœ… <span class="btn-text">ì¶œì„</span></button>
                          <button onclick="checkAttendance(${studentId}, 'ê²°ì„', '${rowId}')" class="btn btn-danger btn-xs">âŒ <span class="btn-text">ê²°ì„</span></button>
                          <a href="/attendance/student/update/${studentId}/" class="btn btn-outline-warning btn-xs">âœï¸ <span class="btn-text">ìˆ˜ì •</span></a>
                        </div>
                    `;
                } else {
                    document.getElementById(rowId).innerHTML = `
                        <div class="cell-actions">
                          <button onclick="cancelAttendance(${studentId}, '${rowId}')" class="btn btn-outline-danger btn-xs">âœ– <span class="btn-text">ì·¨ì†Œ</span></button>
                          <button onclick="endAttendance(${studentId}, '${rowId}', '${name}', '${phone}')" class="btn btn-outline-secondary btn-xs">â¹ <span class="btn-text">ì¢…ë£Œ</span></button>
                          <a href="${smsUrl}" class="btn btn-outline-primary btn-xs">âœ‰ <span class="btn-text">ë¬¸ì</span></a>
                        </div>
                    `;
                }
            } else if (data.status === 'already_checked') {
                alert("ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("status=" + (data.status || "NONE") + "\n" + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
        });
    }

    function cancelAttendance(studentId, rowId) {
        fetch(`/attendance/ajax/cancel/${studentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'canceled') {
                document.getElementById(rowId).innerHTML = `
                  <div class="cell-actions">
                    <button onclick="checkAttendance(${studentId}, 'ì¶œì„', '${rowId}')" class="btn btn-success btn-xs">âœ… <span class="btn-text">ì¶œì„</span></button>
                    <button onclick="checkAttendance(${studentId}, 'ì§€ê°', '${rowId}')" class="btn btn-warning btn-xs">â° <span class="btn-text">ì§€ê°</span></button>
                    <button onclick="checkAttendance(${studentId}, 'ê²°ì„', '${rowId}')" class="btn btn-danger btn-xs">âŒ <span class="btn-text">ê²°ì„</span></button>
                    <a href="/attendance/student/update/${studentId}/" class="btn btn-outline-warning btn-xs">âœï¸ <span class="btn-text">ìˆ˜ì •</span></a>
                  </div>
                `;
            }
        });
    }

    const csrfToken = '{{ csrf_token }}';

    function deleteSelectedStudents() {
        const selected = Array.from(document.querySelectorAll('.student-checkbox:checked'))
            .map(cb => parseInt(cb.value));

        if (selected.length === 0) {
            alert("ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        if (!confirm("ì •ë§ ì„ íƒí•œ í•™ìƒë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("{% url 'delete_selected_students' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ student_ids: selected })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`${data.deleted_count}ëª…ì˜ í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                window.location.reload();
            } else {
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    function toggleRowSelection(row) {
        const checkbox = row.querySelector('.student-checkbox');
        if (!checkbox) return;

        checkbox.checked = !checkbox.checked;
        row.classList.toggle('selected-row', checkbox.checked);
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.student-checkbox').forEach(cb => {
            cb.addEventListener('change', function () {
                const row = this.closest('tr');
                if (row) row.classList.toggle('selected-row', this.checked);
            });
        });
    });
</script>
{% endblock %}
